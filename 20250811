

with  GAB as (
select mv_entity.household_id
      ,'Y' as GAB
from v_committee_gab
inner join mv_entity on mv_entity.donor_id = v_committee_gab.constituent_donor_id
where involvement_role = 'Member'
)

, BOT_and_Alumni as (
select mv_entity.household_id
      ,'Y' as BOT_and_Alumni
from v_committee_trustee
inner join mv_entity on mv_entity.donor_id = v_committee_trustee.constituent_donor_id
inner join mv_entity_ksm_degrees on mv_entity_ksm_degrees.donor_id = v_committee_trustee.constituent_donor_id
)


-- confirm with liam that the data in CATco is correct, if not, create a temp table (DISCUSS FURTHER WITH LIAM.. CREATE TEMP TABLE AND CHECK END DATES?)
-- TALK WITH LIAM
, CSM as (
select mv_entity.household_id
      ,'Y' as CSM
from stg_alumni.ucinn_ascendv2__society_membership__c
inner join mv_entity on mv_entity.donor_id = stg_alumni.ucinn_ascendv2__society_membership__c.ucinn_ascendv2__donor_id_formula__c
where ap_giving_society_name_text__C = 'KSM Cornerstone Donors'
and ucinn_ascendv2__membership_status__c = 'Active'
)

, ebfa as (
select mv_entity.household_id
      ,'Y' as ebfa
from v_committee_asia
inner join mv_entity on mv_entity.donor_id = v_committee_asia.constituent_donor_id
)

/*
, dfc_visit_any_year as (
select distinct mv_entity.household_id
      ,'Y' as dfc_visit_any_year
from stg_alumni.ucinn_ascendv2__contact_report__c
inner join mv_entity on mv_entity.salesforce_id = stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__contact__c
where ucinn_ascendv2__contact_method__c = 'Visit'
and ap_contact_report_author_constituent__c = '003Uz000008fdsIIAQ' -- DFC
)
*/

, dfc_visit_past_year as (
select distinct mv_entity.household_id
       ,'Y' as dfc_visit_past_year
from stg_alumni.ucinn_ascendv2__contact_report__c
inner join mv_entity on mv_entity.salesforce_id = stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__contact__c
cross join v_current_calendar
where ucinn_ascendv2__contact_method__c = 'Visit'
and ap_contact_report_author_constituent__c = '003Uz000008fdsIIAQ' -- DFC
and ucinn_ascendv2__date__c >= DATE '2024-10-01' -- the last date I pulled last years card was october 3rd, so pulling from start of october to be safe
)

, dfc_visit_past_year_data as (
select mv_entity.household_id
    , listagg(stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__date__c, chr(13)) Within Group (Order By stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__date__c) As dfc_visit_past_year_dates
    , listagg(stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__description__c, chr(13)) Within Group (Order By stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__date__c) As dfc_visit_past_year_details
from stg_alumni.ucinn_ascendv2__contact_report__c
inner join mv_entity on mv_entity.salesforce_id = stg_alumni.ucinn_ascendv2__contact_report__c.ucinn_ascendv2__contact__c
cross join v_current_calendar
where ucinn_ascendv2__contact_method__c = 'Visit'
and ap_contact_report_author_constituent__c = '003Uz000008fdsIIAQ' -- DFC
and ucinn_ascendv2__date__c >= DATE '2024-10-01' -- the last date I pulled last years card was october 3rd, so pulling from start of october to be safe
group by mv_entity.household_id
)

/*

- KLC Code (ask Amy)

*/

, planned_gift_donor as (
select distinct household_id
       ,'Y' as planned_gift_donor
from mv_ksm_transactions
where opportunity_type in (
'PGRLE (Retained Life Estate)'
,'PGPIF (Pooled Income Fund)'
,'PGIRA (Distribution from IRA)'
,'PGEST (Realized Estate Gift)'
,'PGCRUT (Charitable Remainder Unitrust)'
,'PGCRAT (Charitable Remainder Annuity Trust)'
,'PGCGA (Charitable Gift Annuity)'
,'PGBEQ (Revocable Bequest)'
,'Life Insurance'
,'Lead Trust'
)
and recognition_credit > 0
and opportunity_stage = 'Active'
)

, kac as (
select mv_entity.household_id
      , 'Y' as kac
from v_committee_kac
inner join mv_entity on mv_entity.donor_id = v_committee_kac.constituent_donor_id
)

, pevc as (
select mv_entity.household_id
      ,'Y' as pevc
from v_committee_privateequity
inner join mv_entity on mv_entity.donor_id = v_committee_privateequity.constituent_donor_id
)

, mbai as (
select mv_entity.household_id
      ,'Y' as mbai
from v_committee_mbai
inner join mv_entity on mv_entity.donor_id = v_committee_mbai.constituent_donor_id
)

, healthcare as (
select mv_entity.household_id
      ,'Y' as healthcare
from v_committee_healthcare 
inner join mv_entity on mv_entity.donor_id = v_committee_healthcare.constituent_donor_id
)

, realestate as (
select mv_entity.household_id
      ,'Y' as realestate
from v_committee_realestcouncil 
inner join mv_entity on mv_entity.donor_id = v_committee_realestcouncil.constituent_donor_id
)

, amp as (
select mv_entity.household_id
      ,'Y' as amp
from v_committee_amp
inner join mv_entity on mv_entity.donor_id = v_committee_amp.constituent_donor_id
)

, phs as (
select mv_entity.household_id
      ,'Y' as phs
from v_committee_phs
inner join mv_entity on mv_entity.donor_id = v_committee_phs.constituent_donor_id
)

/*
-- SERIO WILL COMPLETES
, event_attendee as (

)
*/

, full_circle_recognition_band as (
select household_id
, gs.full_circle_recognition
, Case
  When gs.full_circle_recognition >= 1E6 Then '$1M_kfc_donor'
  When gs.full_circle_recognition >= 100E3 Then '$100K_kfc_donor'
  -- etc
  End
  As full_circle_recognition_band
from mv_ksm_giving_summary gs
Where gs.full_circle_recognition > 0
)


, asia_pevc as (
select mv_entity.household_id
      ,'Y' as asia_pevc
from v_committee_pe_asia
inner join mv_entity on mv_entity.donor_id = v_committee_pe_asia.constituent_donor_id
)

, club_leader as (
select distinct mv_entity.household_id
      ,'Y' as club_leader
from mv_involvement
inner join mv_entity on mv_entity.donor_id = mv_involvement.constituent_donor_id
where involvement_role IN ('Club Leader'
                           ,'President'
                           ,'President-Elect'
                           ,'Director'
                           ,'Secretary'
                           ,'Treasurer'
                           ,'Executive')
--- Current will suffice for the date
and involvement_status = 'Current'
and (involvement_name  like '%Kellogg%'
or involvement_name  like '%KSM%')
)


, yab as (
select mv_entity.household_id
      ,'Y' as yab
from v_committee_yab
inner join mv_entity on mv_entity.donor_id = v_committee_yab.constituent_donor_id
)

, tech as (
select mv_entity.household_id
      ,'Y' as tech
from v_committee_tech
inner join mv_entity on mv_entity.donor_id = v_committee_tech.constituent_donor_id
)

, kfn_associate as (
select mv_entity.household_id
      ,'Y' as kfn_associate
from v_committee_kfn
inner join mv_entity on mv_entity.donor_id = v_committee_kfn.constituent_donor_id
where involvement_role = 'Associate Member'
)


, Professional_list_Recipient as (
select mv_entity.household_id
      ,holiday_card_professional.professional_list_recipient
      ,holiday_card_professional.xcomment
from holiday_card_professional
inner join mv_entity on mv_entity.donor_id = holiday_card_professional.id_number
)

, personalized_list_Recipient as (
select mv_entity.household_id
      ,holiday_card_personalized.personalized_list_recipient
      ,holiday_card_personalized.xcomment
from holiday_card_personalized
inner join mv_entity on mv_entity.donor_id = holiday_card_personalized.id_number
)

, vendor_list_Recipient as (
select mv_entity.household_id
      ,holiday_card_vendor.vendor_list_recipient
      ,holiday_card_vendor.xcomment
from holiday_card_vendor
inner join mv_entity on mv_entity.donor_id = holiday_card_vendor.id_number
)

/*
, professional_fy25_manual_adds as (
select mv_entity.household_id
from mv_entity
where mv_entity.donor_id in (

)
)
*/

/*
, personalized_fy25_manual_adds as (
select mv_entity.household_id
from mv_entity
where mv_entity.donor_id in (

)
)
*/

/*
, vendor_fy25_manual_adds as (
select mv_entity.household_id
from mv_entity
where mv_entity.donor_id in (

)
)
*/


, last_gift as (
select household_id
      ,last_ngc_tx_id
      ,last_ngc_date
      ,last_ngc_opportunity_type
      ,last_ngc_designation_id
      ,last_ngc_designation
      ,last_ngc_recognition_credit
from mv_ksm_giving_summary
)

/*
, family as ( --- *** ask if relationship code has already been built
select *
from stg_alumni.ucinn_ascendv2__contact_report_relation__c
inner join mv_entity on mv_entity.salesforce_id = stg_alumni.ucinn_ascendv2__contact_report_relation__c.ucinn_ascendv2__contact__c
where mv_entity.household_id = 0000648089
)
*/


, dean_salutation as (
select household_id
      ,P_Dean_Salut
      ,p_full_name
      ,P_Dean_Source
      ,Spouse_Dean_Salut
      ,spouse_full_name
      ,Spouse_Dean_Source
      ,Joint_Dean_Salut
      ,Joint_Fullname
from v_entity_salutations
)


, lagm_and_pm as (
select household_id 
       ,prospect_manager_name
       ,lagm_name
from mv_assignments
)


, special_handling as (
select mv_entity.household_id
     ,sh.service_indicators_concat
     ,sh_spouse.service_indicators_concat as spouse_service_indicators_concat
     ,sh.No_contact
     ,sh_spouse.No_contact as spouse_No_contact
     ,sh.NO_Mail_IND
     ,sh_spouse.NO_Mail_IND as spouse_NO_Mail_IND
     ,sh.NO_EMail_IND 
     ,sh_spouse.NO_EMail_IND as spouse_NO_EMail_IND
from mv_entity
left join mv_special_handling sh on sh.donor_id = mv_entity.donor_id
left join mv_special_handling sh_spouse on sh_spouse.donor_id = mv_entity.spouse_donor_id
where mv_entity.household_primary = 'Y'
--and mv_entity.HOUSEHOLD_ID = '0001048101' -- spot check (primary and spouse have different SH codes
)


--- Employment - primary
--- Also use keep dense rank function to pull most recent employee start date

, employ as (
select distinct mv_entity.household_id
       ,max (c.ap_is_primary_employment__c) keep (dense_rank First Order by c.ucinn_ascendv2__start_date__c desc) as primary_employ_ind
       ,max (c.ucinn_ascendv2__job_title__c) keep (dense_rank first order by c.ucinn_ascendv2__start_date__c desc) as primary_job_title
       ,max (c.UCINN_ASCENDV2__RELATED_ACCOUNT_NAME_FORMULA__C) keep (dense_rank first order by c.ucinn_ascendv2__start_date__c desc) as primary_employer
from stg_alumni.ucinn_ascendv2__Affiliation__c c
inner join mv_entity on mv_entity.donor_id = c.UCINN_ASCENDV2__RELATED_CONTACT_DONOR_ID_FORMULA__C
where c.ap_is_primary_employment__c = 'true'
group by mv_entity.household_id
)

/*
-- email (this subquery is adding duplicates, might not need to include if we don't have vendor cards this year)
, email as (
select distinct mv_entity.household_id
       ,c.email
from stg_alumni.contact c
inner join mv_entity on mv_entity.donor_id = c.ucinn_ascendv2__donor_id__c
)
*/

-- Holiday Card Notes from Last Year
, KDHC_Notes_FY25_HH as (
select mv_entity.household_id
      ,KDHC_Notes_FY25.Segment_Description
      ,KDHC_Notes_FY25.Note_Text
from KDHC_Notes_FY25
inner join mv_entity on mv_entity.donor_id = KDHC_Notes_FY25.Id_Number
)



-- add KDHC_Notes_FY25 to code
select distinct mv_entity.household_id
      ,mv_entity.household_primary
      ,dean_salutation.P_Dean_Salut
      ,dean_salutation.p_full_name
      ,mv_entity.institutional_suffix
      ,special_handling.service_indicators_concat
      ,special_handling.No_contact
      ,special_handling.NO_Mail_IND
      ,special_handling.NO_EMail_IND 
      ,dean_salutation.Spouse_Dean_Salut
      ,dean_salutation.spouse_full_name
      ,mv_entity.spouse_institutional_suffix
      ,special_handling.spouse_service_indicators_concat
      ,special_handling.spouse_No_contact
      ,special_handling.spouse_NO_Mail_IND
      ,special_handling.spouse_NO_EMail_IND
      ,dean_salutation.Joint_Dean_Salut
      ,dean_salutation.Joint_Fullname
      ,employ.primary_job_title
      ,employ.primary_employer
      ,lagm_and_pm.prospect_manager_name
      ,lagm_and_pm.lagm_name
      ,GAB.GAB
      ,BOT_and_Alumni.BOT_and_Alumni
      ,CSM.CSM
      ,ebfa.ebfa
      ,dfc_visit_past_year.dfc_visit_past_year
      ,planned_gift_donor.planned_gift_donor
      ,kac.kac
      ,pevc.pevc
      ,mbai.mbai
      ,healthcare.healthcare
      ,realestate.realestate
      ,amp.amp
      ,phs.phs
      ,full_circle_recognition_band.full_circle_recognition_band
      ,asia_pevc.asia_pevc
      ,club_leader.club_leader
      ,yab.yab
      ,tech.tech
      ,kfn_associate.kfn_associate
      , Case When GAB.GAB Is Not Null Then 'GAB, ' End ||
         Case When BOT_AND_ALUMNI Is Not Null Then 'BOT & alumni, ' End ||
         Case When CSM.CSM Is Not Null Then 'Cornerstone, ' End ||
         Case When ebfa.ebfa Is Not Null Then 'EBfA, ' End ||
         Case When dfc_visit_past_year.dfc_visit_past_year Is Not Null Then 'DFC visit past year, ' End ||
         --Case When KLC.KLC Is Not Null Then 'KLC, ' End ||
         Case When planned_gift_donor.planned_gift_donor Is Not Null Then 'Planned gift donor, ' End ||
         Case When KAC.KAC Is Not Null Then 'KAC, ' End ||
         Case When PEVC.PEVC Is Not Null Then 'PEVC, ' End ||  
         Case When Asia_PEVC.Asia_PEVC Is Not Null Then 'Asia PEVC, ' End ||
         Case When MBAi.MBAi Is Not Null Then 'MBAi, ' End ||
         Case When healthcare.healthcare Is Not Null Then 'Healthcare, ' End ||
         Case When RealEstate.RealEstate Is Not Null Then 'Real Estate, ' End ||
         Case When AMP.AMP Is Not Null Then 'AMP, ' End ||
         Case When PHS.PHS Is Not Null Then 'PHS, ' End ||
         --Case When event_attendee.event_attendee Is Not Null Then 'Event attendee, ' End ||
         Case When full_circle_recognition_band = '$1M_kfc_donor' Then '$1M_kfc_donor, ' End ||
         Case When full_circle_recognition_band = '$100K_kfc_donor' Then '$100K_kfc_donor, ' End ||
         Case When Club_Leader.Club_Leader Is Not Null Then 'Club Leader, ' End ||
         Case When yab.yab Is Not Null Then 'YAB, ' End ||
         Case When tech.tech Is Not Null Then 'Tech Council, ' End ||
         Case When KFN_Associate.KFN_Associate Is Not Null Then 'KFN Associate, ' End
       As flags_concatenated
      ,vendor_list_Recipient.vendor_list_Recipient
      ,Professional_list_Recipient.Professional_list_Recipient
      ,personalized_list_Recipient.personalized_list_Recipient
      ,KDHC_Notes_FY25_HH.Segment_Description
      ,KDHC_Notes_FY25_HH.Note_Text
      ,dfc_visit_past_year_data.dfc_visit_past_year_dates
      ,dfc_visit_past_year_data.dfc_visit_past_year_details
      ,last_gift.last_ngc_tx_id
      ,last_gift.last_ngc_date
      ,last_gift.last_ngc_opportunity_type
      ,last_gift.last_ngc_designation_id
      ,last_gift.last_ngc_designation
      ,last_gift.last_ngc_recognition_credit
from mv_entity
left join GAB on GAB.household_id = mv_entity.household_id
left join BOT_and_Alumni on BOT_and_Alumni.household_id = mv_entity.household_id
left join CSM on CSM.household_id = mv_entity.household_id
left join ebfa on ebfa.household_id = mv_entity.household_id
left join dfc_visit_past_year on dfc_visit_past_year.household_id = mv_entity.household_id
left join dfc_visit_past_year_data on dfc_visit_past_year_data.household_id = mv_entity.household_id
left join planned_gift_donor on planned_gift_donor.household_id = mv_entity.household_id
left join kac on kac.household_id = mv_entity.household_id
left join pevc on pevc.household_id = mv_entity.household_id
left join asia_pevc on asia_pevc.household_id = mv_entity.household_id
left join mbai on mbai.household_id = mv_entity.household_id
left join healthcare on healthcare.household_id = mv_entity.household_id
left join realestate on realestate.household_id = mv_entity.household_id
left join amp on amp.household_id = mv_entity.household_id
left join phs on phs.household_id = mv_entity.household_id
left join full_circle_recognition_band on full_circle_recognition_band.household_id = mv_entity.household_id
left join club_leader on club_leader.household_id = mv_entity.household_id
left join yab on yab.household_id = mv_entity.household_id
left join tech on tech.household_id = mv_entity.household_id
left join kfn_associate on kfn_associate.household_id = mv_entity.household_id
left join Professional_list_Recipient on Professional_list_Recipient.household_id = mv_entity.household_id
left join personalized_list_Recipient on personalized_list_Recipient.household_id = mv_entity.household_id
left join vendor_list_Recipient on vendor_list_Recipient.household_id = mv_entity.household_id
left join last_gift on last_gift.household_id = mv_entity.household_id
left join dean_salutation on dean_salutation.household_id = mv_entity.household_id
left join lagm_and_pm on lagm_and_pm.household_id = mv_entity.household_id
left join special_handling on special_handling.household_id = mv_entity.household_id
left join employ on employ.household_id = mv_entity.household_id
left join KDHC_Notes_FY25_HH on KDHC_Notes_FY25_HH.household_id = mv_entity.household_id
where mv_entity.household_primary = 'Y'
